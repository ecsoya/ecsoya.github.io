---
layout: post
date:   2018-11-20
categories: [scf]
title: è…¾è®¯äº‘æ— æœåŠ¡å™¨äº‘å‡½æ•°å®è·µ
---

ä»ä¼ ç»Ÿçš„æœåŠ¡å™¨åˆ°è¿‘å¹´é£ç”Ÿæ°´èµ·çš„äº‘æœåŠ¡å™¨å¾®æœåŠ¡æ¶æ„ï¼Œå†åˆ°æ— æœåŠ¡å™¨(Serverless)æ¶æ„ï¼Œå¼€å‘è€…ä»¬çš„æ¢ç´¢ä¹‹è·¯æ°¸ä¸åœæ­‡ï¼

* [AWS Lambda](https://docs.aws.amazon.com/zh_cn/lambda/latest/dg/welcome.html)
* [å¾®è½¯Azure Functions](https://azure.microsoft.com/en-us/services/functions/)
* [Google Cloud Functions](https://cloud.google.com/functions/docs/tutorials)
* [Apache OpenWhisk](http://openwhisk.incubator.apache.org/)
* [é˜¿é‡Œäº‘å‡½æ•°è®¡ç®—](https://promotion.aliyun.com/ntms/act/fc/doc.html?spm=5176.137990.1214002.btn3.7e9b224eKcWICE&wh_ttid=pc)
* [è…¾è®¯äº‘æ— æœåŠ¡å™¨äº‘å‡½æ•°](https://cloud.tencent.com/document/product/583)

è™½ç„¶å„å®¶çš„åç§°éƒ½ä¸ä¸€æ ·ï¼Œä½†æ€»ä½“æ¥è¯´éƒ½æ˜¯åŸºäºFaaSï¼ˆFunction as a Serviceï¼‰ï¼Œæ‰€æœ‰çš„äº‹æƒ…éƒ½æ˜¯åŸºäºå‡½æ•°å»åšã€‚

å®ƒå¯ä»¥ç»“åˆAPIç½‘å…³æ¥è°ƒç”¨ï¼Œè¿›è€Œè¾¾åˆ°ä¼ ç»ŸæœåŠ¡å™¨çš„åŠŸèƒ½ã€‚

### ä¼˜ç‚¹

1. ä¸éœ€è¦ç®¡ç†ï¼Œä¼˜åŒ–æœåŠ¡å™¨ï¼Œä»€ä¹ˆå¼¹æ€§ä¼¸ç¼©ï¼Œè´Ÿè½½å‡è¡¡éƒ½ä¸ç”¨è‡ªå·±å»åšã€‚
2. ç›¸å¯¹å®‰å…¨ï¼Œå¯é ï¼Œå› ä¸ºè¿™äº›äº‹æƒ…éƒ½ç”±äº§å•†æ¥å®Œæˆã€‚
3. å¯ç”¨åº¦é«˜ï¼Œè§¦å‘æ‰§è¡Œï¼Œæœ‰éœ€è¦çš„æ—¶å€™æ‰ä¼šæ‰§è¡Œï¼Œç©ºé—²0æˆæœ¬ã€‚
4. å¼€å‘è€…å¯ä»¥åªå…³æ³¨ä¸šåŠ¡é€»è¾‘ï¼Œå…¶å®ƒçš„ä¸€æ¦‚ä¸ç®¡ã€‚

ç”±äºä¹°äº†è…¾è®¯çš„äº‘æœåŠ¡å™¨ï¼Œé¡ºå¸¦å°±è¯•äº†ä¸€ä¸‹å¦‚ä½•åˆ›å»ºè…¾è®¯åˆ†æ— æœåŠ¡å™¨äº‘å‡½æ•°ã€‚

æ”¯æŒçš„è¯­è¨€æœ‰ï¼š`Python2.7`, `Python3.6`, `Nodejs6.10`, `Nodejs8.9`, `Java8`, `Php5.6`, `Php7.2`, `Golang1`

#### å¼€å‘æ­¥éª¤ï¼š
1. åœ¨`æ— æœåŠ¡å™¨äº‘å‡½æ•°`æ§åˆ¶å°æ–°å»ºå‡½æ•°æœåŠ¡ã€‚
2. ä¸Šä¼ è‡ªå·±çš„ä»£ç ï¼ˆjaræˆ–zipï¼‰ã€‚
3. æµ‹è¯•

#### æ³¨æ„äº‹é¡¹ï¼š
1. Javaç‰ˆæœ¬æ˜¯8.0
2. Javaæ‰§è¡Œæ–¹æ³•æ ¼å¼ä¸ºï¼š`[package].[class]::[method]`ï¼Œæ³¨æ„åŒ…ååªèƒ½æ˜¯ä¸€çº§ï¼Œè¿˜ä¸æ”¯æŒå¤šçº§åŒ…åï¼ˆå¥½åƒæœ‰å‘ï¼ŒğŸ˜ï¼‰ã€‚
3. æ—¥å¿—ï¼š`System.out.print`å°±å¯ä»¥ï¼Œæˆ–è€…ä½¿ç”¨`java.util.logging`ï¼Œç”±äºæ— æ³•è”è°ƒï¼Œæ—¥å¿—ä¿¡æ¯å¾ˆé‡è¦ã€‚

#### Demo

```Java
public class Function {

	public String handle(Input input) {
		System.out.println("-----------------");
		System.out.println("Input: " + input);
		if (input == null || input.getName() == null) {
			return "å‘ç”Ÿé”™è¯¯";
		}
		String result = input.getName().toUpperCase();
		System.out.println("Result: " + result);
		return result;
	}
}

public class Input {

	private String name;

	public String getName() {
		return name;
	}

	public void setName(String name) {
		this.name = name;
	}

}

```
æµ‹è¯•æ¨¡æ¿ï¼š

```json
{"name":"abcd"}
```
æ—¥å¿—ï¼š

```

START RequestId: f389b1c9-edff-11e8-b97c-525400c7c826

Event RequestId: f389b1c9-edff-11e8-b97c-525400c7c826Event:{

  "name": "abcd"

}

-----------------

Input: demo.Input@4de8b406

Result: ABCD


END RequestId: f389b1c9-edff-11e8-b97c-525400c7c826

Report RequestId: f389b1c9-edff-11e8-b97c-525400c7c826 Duration:854.408ms Memory:128MB MaxMemoryUsed:31.168MB
```

è¯´å®è¯è…¾è®¯äº‘çš„bugè¿˜çœŸä¸å°‘ï¼Œç½‘é¡µæ§åˆ¶å°é‡Œé¢å±…ç„¶æ²¡æœ‰Stringç±»å‹çš„æ¨¡æ¿ï¼Œéå¾—ç”¨JSONï¼ŒğŸ˜ã€‚
ä¸è¿‡ä¹Ÿå¥½ï¼Œåƒè¿™æ ·ç®€å•çš„ä¾‹å­å®é™…ä¸­ä¹Ÿä¸å­˜åœ¨ã€‚

### ç¼–å†™å‡½æ•°ä»£ç æ€»ç»“

ä¸€ï¼Œäº‹ä»¶å…¥å‚ï¼ˆå‡½æ•°ä¸­çš„ç¬¬ä¸€ä¸ªå˜é‡ï¼‰
    
   * JavaåŸºç¡€ç±»å‹åŒ…æ‹¬String
   * POJOç±»å‹ï¼Œå¿…é¡»æœ‰å…¬æœ‰getterå’Œsetteræ–¹æ³•ã€‚

äºŒï¼ŒContextå…¥å‚ï¼ˆå‡½æ•°ä¸­çš„ç¬¬äºŒä¸ªå˜é‡ä¸ºContextç±»å‹ï¼‰

```Java
import com.qcloud.scf.runtime.Context
...
public String handle(Input input, Context context) {
    //
}
```
Contextæ˜¯ä»€ä¹ˆï¼Ÿæ¯å®¶çš„å‡½æ•°æœåŠ¡éƒ½ä¼šä¼ ä¸€ä¸ªContextå‚æ•°è¿›å»ï¼Œä¸€èˆ¬æ˜¯è¿™ä¸ªå‡½æ•°ç›¸å…³çš„ä¸€äº›å˜é‡ï¼Œå¦‚åç§°ï¼Œå†…å­˜é…ç½®ç­‰ï¼Œæœ‰äº›ä¹Ÿä¼šç›´æ¥ä¼ ä¸€ä¸ªloggerå¯¹è±¡è¿›å»ï¼Œ
è…¾è®¯äº‘çš„Contextç°åœ¨è¿˜æ¯”è¾ƒé¸¡è‚‹ï¼š

```Java
package com.qcloud.scf.runtime;

public abstract interface Context {
	public abstract String getRequestId();

	public abstract int getTimeLimitInMs();

	public abstract int getMemoryLimitInMb();

	// public abstract String getFunctionName();

	// public abstract String getFunctionVersion();

	// public abstract String getMemoryLimitInMb();

	// public abstract String getTimeLimitInMs();

	// public abstract String getLogGroupName();

	// public abstract String getLogStreamName();

}
```

ä¸‰ï¼Œè¿”å›ç»“æœå¯ä»¥æ˜¯JavaåŸºç¡€ç±»ï¼ŒStringå’ŒPOJOã€‚

å››ï¼Œ Mavenæ‰“åŒ…ï¼Œéœ€è¦ç”¨shadeæ’ä»¶å°†æ‰€æœ‰jaråŒ…æ‰“åˆ°ä¸€èµ·

```xml
<build>
    <plugins>
      <plugin>
        <groupId>org.apache.maven.plugins</groupId>
        <artifactId>maven-shade-plugin</artifactId>
        <version>2.3</version>
        <configuration>
          <createDependencyReducedPom>false</createDependencyReducedPom>
        </configuration>
        <executions>
          <execution>
            <phase>package</phase>
            <goals>
              <goal>shade</goal>
            </goals>
          </execution>
        </executions>
      </plugin>
    </plugins>
</build>
```

### SDKçš„ä½¿ç”¨

è…¾è®¯äº‘SDKåœ¨[Github](https://github.com/TencentCloud/tencentcloud-sdk-java)ä¸Šæœ‰æºç å¼€å‘ï¼Œæ˜¯å·²ç»å°è£…å¥½äº†çš„APIï¼Œä¹Ÿå¯ä»¥é€šè¿‡Mavenæ¥å¼•ç”¨ï¼š

```xml
<dependency>
	<groupId>com.tencentcloudapi</groupId>
	<artifactId>tencentcloud-sdk-java</artifactId>
	<version>3.0.29</version>
</dependency>
```

é¦–å…ˆï¼šå®ä¾‹åŒ–è®¤è¯å¯¹è±¡ï¼Œéœ€è¦è…¾è®¯äº‘è´¦æˆ·`secretId`å’Œ`secretKey`

```Java
// å®ä¾‹åŒ–ä¸€ä¸ªè®¤è¯å¯¹è±¡ï¼Œå…¥å‚éœ€è¦ä¼ å…¥è…¾è®¯äº‘è´¦æˆ·secretIdï¼ŒsecretKey
Credential credential = new Credential(secretId, secretKey);
ClientProfile profile = new ClientProfile(ClientProfile.SIGN_SHA256);
ScfClient scfClient = new ScfClient(credential, region, profile);
```

ç„¶åé€šè¿‡ï¼š`CreateFunctionRequest`ï¼Œ`DeleteFunctionRequest`ï¼Œ`ListFunctionsRequest`ç­‰è¿›è¡Œå‡½æ•°çš„åˆ›å»ºï¼Œåˆ é™¤ç­‰æ“ä½œã€‚

```Java
CreateFunctionRequest createRequest = new CreateFunctionRequest();
if (uploaded) {
  Code code = new Code();
  code.setCosBucketName(function.getBucket().getName());
  code.setCosBucketRegion(function.getBucket().getRegion());
  code.setCosObjectName(functionName);
  createRequest.setCode(code);
}
createRequest.setDescription(function.getDescription());
createRequest.setRuntime(RUNTIME);
createRequest.setFunctionName(functionName);
createRequest.setHandler(handler);
try {
  scfClient.CreateFunction(createRequest);
} catch (TencentCloudSDKException e) {
  throw e;
}
```

### æºç ä¸Šä¼ 

æºç ä¸Šä¼ æœ‰2ä¸­æ–¹å¼ï¼š

1. ç›´æ¥å°†æ‰“å¥½çš„jaråŒ…æˆ–zipåŒ…é€šè¿‡ç½‘é¡µæ§åˆ¶å°ä¸Šä¼ ã€‚
2. é€šè¿‡COSï¼ˆè…¾è®¯äº‘å¯¹è±¡å­˜å‚¨ï¼‰ä¸Šä¼ ã€‚
    _é€šè¿‡COSä¸Šä¼ ï¼Œé¦–å…ˆè¦æŠŠä½ çš„jaråŒ…æˆ–zipåŒ…ä¸Šä¼ åˆ°å¯¹è±¡å­˜å‚¨ï¼Œç„¶ååœ¨æ§åˆ¶å°ä¸­è¿›è¡Œå…³è”å°±å¯ä»¥äº†_
    
æ³¨æ„çš„ä¸€ç‚¹ï¼š
é€šè¿‡SDK+COSä¸Šä¼ ä»£ç çš„æ—¶å€™ï¼ŒCOSçš„`bucketName`ä¸è¦å¸¦åé¢çš„`appid`ï¼Œä¸€èˆ¬æƒ…å†µä¸‹è½½å¯¹è±¡å­˜å‚¨ä¸­åç§°æ˜¯æœ‰`[name]-[appid]`ç»„æˆçš„ã€‚

ä¸Šä¼ çš„ä»£ç å¦‚ä¸‹ï¼š

```Java
COSCredentials cred = new BasicCOSCredentials(function.getSecretId(), function.getSecretKey());
ClientConfig clientConfig = new ClientConfig(new Region(bucketRegion));
COSClient cosClient = new COSClient(cred, clientConfig);
if (!cosClient.doesBucketExist(bucketName)) {
  CreateBucketRequest request = new CreateBucketRequest(bucketSimpleName);
  cosClient.createBucket(request);
  cosClient.setBucketAcl(bucketName, CannedAccessControlList.PublicRead);
} else {
  cosClient.putObject(bucketName, function.getName(), mavenProject.getArtifact().getFile());
}
cosClient.shutdown();
```

æ³¨æ„ï¼šè¿™é‡Œçš„bucketNameä¸€å®šè¦æ˜¯å…¨åï¼šï¼ˆ`[name]-[appid]`ï¼‰ã€‚

ä½†æ˜¯å¦‚æœç”¨SDKæ›´æ–°äº‘å‡½æ•°ï¼šä¸€å®šè®°å¾—ä¸è¦å¸¦`[appid]`ï¼Œåªä½¿ç”¨å‰é¢çš„`[name]`ä½œä¸º`bucketName`ã€‚

```Java
Credential credential = new Credential(secretId, secretKey);
ClientProfile profile = new ClientProfile(ClientProfile.SIGN_SHA256);
ScfClient scfClient = new ScfClient(credential, region, profile);
UpdateFunctionCodeRequest updateCodeRequest = new UpdateFunctionCodeRequest();
updateCodeRequest.setFunctionName(functionName);
updateCodeRequest.setHandler(handler);
updateCodeRequest.setCosBucketName(bucketName);
updateCodeRequest.setCosBucketRegion(bucketRegion);
updateCodeRequest.setCosObjectName(objectName);

scfClient.UpdateFunctionCode(updateCodeRequest);
```

æ›¾ç»å› ä¸ºè¿™ä¸ªé—®é¢˜ï¼Œæäº†å·¥å•è¿›è¡Œäº†å¥½å¤šæ¬¡çš„é‡è¯•ã€‚**åˆ‡è®°**ï¼

##### æ›´å¤šï¼š
* [å‚è€ƒæºç ](https://github.com/ecsoya/tencent-function-gateway)
* [è…¾è®¯äº‘APIç½‘å…³](http://blog.ecsoya.work/%E8%85%BE%E8%AE%AF%E4%BA%91/2018/11/21/api-gateway.html)
* [åŸºäºSpringBootçš„è…¾è®¯äº‘å‡½æ•°è°ƒè¯•](http://blog.ecsoya.work/%E8%85%BE%E8%AE%AF%E4%BA%91/2018/11/22/scf-boot.html)
* [åŸºäºè…¾è®¯äº‘å¯¹è±¡å­˜å‚¨ï¼Œæ„å»ºè‡ªåŠ¨ä¸Šä¼ æ— æœåŠ¡å‡½æ•°çš„Mavenæ’ä»¶](http://blog.ecsoya.work/%E8%85%BE%E8%AE%AF%E4%BA%91/2018/11/24/scf-maven.html)
